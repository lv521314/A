
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨小岛✨</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C757D;
            --primary-light: #ADB5BD;
            --primary-dark: #495057;
            --accent: #5C636A;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --dark: #212529;
            --light: #F8F9FA;
            --gray: #6C757D;
            --border: #DEE2E6;
            --card-bg: rgba(248, 249, 250, 0.98);
            --sidebar-bg: #E9ECEF;
            --highlight: #6C757D;
            --gradient-primary: linear-gradient(135deg, #6C757D 0%, #ADB5BD 100%);
            --gradient-accent: linear-gradient(135deg, #5C636A 0%, #868E96 100%);
            --gradient-success: linear-gradient(135deg, #28A745 0%, #5CB85C 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius: 12px;
            --radius-lg: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: #F8F9FA;
            color: var(--dark);
            line-height: 1.5;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        /* 顶部导航栏样式 */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 2rem;
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
            border-radius: 20px;
            margin: 10px;
            transition: all 0.3s ease;
        }

        /* 关键词方块样式 */
        .keyword-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .keyword-tag {
            padding: 0.75rem;
            background-color: #E9ECEF;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .nav-logo {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px;
            border-radius: 20px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 15px;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.4);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* 登录遮罩层样式 */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        
        .login-container {
            background-color: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            transform: scale(0.95);
            animation: scaleUp 0.3s ease-out forwards;
        }
        
        .login-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .login-input {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.2);
        }
        
        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .login-btn:hover {
            background: linear-gradient(135deg, #495057 0%, #6C757D 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .login-error {
            color: var(--danger);
            margin-top: 1rem;
            font-size: 0.875rem;
            animation: shake 0.5s ease;
        }
        
        .login-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes scaleUp {
            to { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .app-container {
            padding: 2rem;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 0.2s forwards;
        }

        /* 页面内容样式 */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 卡片样式 */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            text-align: center;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(173, 181, 189, 0.1) 100%);
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, rgba(253, 121, 168, 0.1) 0%, rgba(232, 67, 147, 0.1) 100%);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(92, 184, 92, 0.1) 100%);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            transition: all 0.3s ease;
        }

        /* 关键词管理 */
        .keyword-manager {
            margin-bottom: 1.5rem;
        }

        .keyword-search {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .keyword-search:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.2);
        }

        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .keyword-tag {
            padding: 0.5rem 1rem;
            background-color: #E9ECEF;
            border-radius: 2rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            box-shadow: var(--shadow-sm);
        }

        .keyword-tag:hover {
            background-color: #DEE2E6;
            transform: translateY(-2px);
        }

        .keyword-tag.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 6px rgba(108, 117, 125, 0.3);
        }

        .custom-keywords {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background-color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .blacklist-keywords {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background-color: rgba(255, 255, 255, 0.8);
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }

        .keyword-note {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 0.5rem;
        }

        /* 区域选择器 */
        .area-selector {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .area-option {
            padding: 0.75rem 1.5rem;
            background-color: #E9ECEF;
            border-radius: 2rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: var(--shadow-sm);
        }

        .area-option:hover {
            background-color: #DEE2E6;
            transform: translateY(-2px);
        }

        .area-option.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 6px rgba(108, 117, 125, 0.3);
        }

        /* 延迟控制 */
        .delay-control {
            margin-bottom: 1.5rem;
        }

        .delay-slider {
            width: 100%;
            margin: 1rem 0;
            -webkit-appearance: none;
            height: 0.5rem;
            border-radius: 0.25rem;
            background: #E9ECEF;
            outline: none;
            transition: all 0.3s ease;
        }

        .delay-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .delay-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--primary-dark);
        }

        .delay-value {
            font-weight: 600;
            color: var(--primary-dark);
            transition: all 0.3s ease;
        }

        /* 刷新时间控制 */
        .refresh-control {
            margin-bottom: 1.5rem;
        }

        .refresh-slider {
            width: 100%;
            margin: 1rem 0;
            -webkit-appearance: none;
            height: 0.5rem;
            border-radius: 0.25rem;
            background: #E9ECEF;
            outline: none;
            transition: all 0.3s ease;
        }

        .refresh-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .refresh-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #495057;
        }

        .refresh-value {
            font-weight: 600;
            color: var(--accent);
            transition: all 0.3s ease;
        }

        /* 复选框 */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .checkbox-container input {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* 按钮 */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            box-shadow: var(--shadow-sm);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #495057 0%, #6C757D 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--dark);
        }

        .btn-outline:hover {
            background-color: #E9ECEF;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn-danger {
            background: linear-gradient(135deg, #DC3545 0%, #C82333 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #C82333 0%, #DC3545 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* 日志区域 */
        .log-stream {
            height: 300px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: var(--radius);
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            transition: all 0.3s ease;
        }

        .log-entry {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px dashed var(--border);
            animation: fadeIn 0.3s ease-out;
        }

        .log-time {
            color: var(--gray);
            margin-right: 0.5rem;
        }

        .log-message.success {
            color: var(--success);
            font-weight: 500;
        }

        .log-message.warning {
            color: var(--warning);
            font-weight: 500;
        }

        .log-message.error {
            color: var(--danger);
            font-weight: 500;
        }

        .log-message.highlight {
            color: var(--primary);
            font-weight: 600;
        }

        .log-message.info {
            color: var(--dark);
        }

        .log-message.refresh {
            color: var(--accent);
        }

        .log-message.order {
            color: var(--success);
            font-weight: 600;
        }

        /* 表单元素 */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.2);
        }

        /* 记录表格 */
        .record-table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .record-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.875rem;
            background-color: var(--card-bg);
            transition: all 0.3s ease;
        }

        .record-table th {
            background: var(--gradient-primary);
            color: white;
            padding: 0.75rem 1rem;
            text-align: left;
            position: sticky;
            top: 0;
            transition: all 0.3s ease;
        }

        .record-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .record-table tr:nth-child(even) {
            background-color: #F8F9FA;
        }

        .record-table tr:hover {
            background-color: #E9ECEF;
        }

        .records-summary {
            padding: 1rem;
            background-color: rgba(108, 117, 125, 0.1);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .records-summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .records-summary-label {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .records-summary-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
            transition: all 0.3s ease;
        }

        /* 新增样式 */
        .summary-card {
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(173, 181, 189, 0.1) 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .summary-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .summary-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .summary-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .summary-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            transition: all 0.3s ease;
        }
        
        .emoji-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
            transition: all 0.3s ease;
        }
        
        .status-settled {
            background: rgba(40, 167, 69, 0.2);
            color: #28A745;
        }
        
        .status-unsettled {
            background: rgba(255, 193, 7, 0.2);
            color: #DC3545;
        }
        
        .refresh-btn {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            background: rgba(108, 117, 125, 0.1);
            border-radius: 6px;
            color: var(--primary);
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: rgba(108, 117, 125, 0.2);
        }
        
        .show-more {
            text-align: center;
            padding: 8px;
            color: var(--gray);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .show-more:hover {
            color: var(--primary);
        }

        /* 性能监控面板 */
        .performance-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.9);
            border-radius: var(--radius);
            transition: all 0.3s ease;
        }
        .perf-metric {
            text-align: center;
        }
        .perf-value {
            font-size: 1.2rem;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .perf-label {
            font-size: 0.75rem;
            color: var(--gray);
        }
        .dynamic-speed {
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, #6C757D, #ADB5BD, #6C757D);
            margin-top: 0.5rem;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        .speed-indicator {
            height: 100%;
            background: var(--dark);
            width: 50%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* 状态指示器 */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #E9ECEF;
            border-radius: 2rem;
            font-size: 0.875rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .indicator {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background-color: var(--gray);
            transition: all 0.3s ease;
        }

        .indicator.active {
            background-color: var(--success);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
            animation: pulse 1.5s infinite;
        }

        /* 新增余额显示样式 */
        .balance-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .balance-item {
            text-align: center;
            flex: 1;
            padding: 0.5rem;
            transition: all 0.3s ease;
        }

        .balance-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .balance-value {
            font-size: 1.25rem;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .performance-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .top-nav {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
            }
            
            .nav-links {
                margin-top: 1rem;
                width: 100%;
                justify-content: space-between;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .area-selector {
                flex-direction: column;
            }
            
            .performance-panel {
                grid-template-columns: 1fr;
            }
            
            .balance-container {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* 动画效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* 新增加载动画 */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(108, 117, 125, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        /* 优化表格行动画 */
        .table-row {
            transition: all 0.3s ease;
        }
        
        .table-row-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        
        .table-row-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease;
        }
        
        /* 优化API加载状态 */
        .api-loading {
            position: relative;
        }
        
        .api-loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- 登录遮罩层 -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <h2 class="login-title">🔑 卡密登录🔑</h2>
            <input type="text" class="login-input" id="cardKeyInput" placeholder="请输入卡密">
            <button class="login-btn" id="loginBtn">登录</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- 顶部导航栏 -->
    <div class="top-nav" id="topNav" style="display: none;">
        <div class="nav-logo">ㅤㅤㅤㅤㅤ  ㅤ ㅤ ㅤㅤ✨ 小岛抢单✨</div>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-tab="dashboard">✨抢单页面✨</a>
            <a href="#" class="nav-link" data-tab="settings">✨用户信息✨</a>
            <a href="#" class="nav-link" data-tab="records">✨抢单记录✨</a>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- 控制台标签页 -->
        <div id="dashboard-tab" class="tab-content active fade-in">
            <div class="header">
                <h1 class="card-title"> ‎‎‎‎ㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤ🚀抢单控制台</h1>
<div class="status-indicator">
                    <div class="indicator"></div>
                    <span>ㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤㅤ ㅤㅤ未运行</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">📊 实时监控</h2>
                    <span id="lastUpdate">最后更新: -</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">今日抢单成功</div>
                        <div class="stat-value" id="successCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">未结算总金额</div>
                        <div class="stat-value" id="unsettledAmount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">已结算总金额</div>
                        <div class="stat-value" id="settledAmount">0</div>
                    </div>
                </div>
            </div>

            <div class="card keyword-manager">
                <div class="card-header">
                    <h2 class="card-title">ㅤㅤㅤㅤㅤㅤㅤㅤ🔍 过滤订单管理🔍</h2>
                </div>

                <div class="keyword-grid">
                    <button class="keyword-tag active">开荒单</button>
                    <button class="keyword-tag">暑假快乐单</button>
                    <button class="keyword-tag">狗家专属护航单</button>
                    <button class="keyword-tag">赌刀单</button>
                    <button class="keyword-tag">赌狗单</button>
                    <button class="keyword-tag">赌鸡单</button>
                    <button class="keyword-tag">护航加强单</button>
                    <button class="keyword-tag">实验基地专属</button>
                    <button class="keyword-tag">烽火荣都专属</button>   
                    <button class="keyword-tag">冰河禁区专属</button>   
                    <button class="keyword-tag">苏尔南清图单</button>   
                    <button class="keyword-tag">苏尔南钻石单</button>   
                    <button class="keyword-tag">金色狗牌单</button>   
                    <button class="keyword-tag">至尊护航单</button>
                    <button class="keyword-tag">狙击俱乐部单</button>
                    <button class="keyword-tag">大神护航单</button>
                    <button class="keyword-tag">赌超级物资箱</button>
                    <button class="keyword-tag">保底BOSS金光单</button>
                    <button class="keyword-tag">给打手加鸡腿</button>
                    <button class="keyword-tag">给打手加汉堡</button>                   
                    <button class="keyword-tag">给打手喝奶茶</button>
                </div>
                
                <input type="text" class="custom-keywords" placeholder="自定义关键词，用逗号分隔" id="customKeywords">
                            </div>
            <input type="text" class="blacklist-keywords" placeholder="黑名单用户关键词，用逗号分隔" id="blacklistKeywords">
                
            <div class="card">
                <div class="card-header">
                           <h2 class="card-title">ㅤㅤㅤㅤㅤㅤㅤㅤ🌐 区域选择🌐</h2>
                </div>
                
                <div class="area-selector">
                    <button class="area-option active" data-area="all">全部区域</button>
                    <button class="area-option" data-area="Q">Q区</button>
                    <button class="area-option" data-area="V">V区</button>
                </div>
            </div>

            <div class="card delay-control">
                <div class="card-header">
                    <h2 class="card-title">ㅤㅤㅤㅤㅤ ㅤㅤ⏱️ 抢单延迟设置⏱️</h2>
                </div>
                
                <input type="range" class="delay-slider" id="delaySlider" min="1" max="50" value="15">
                <div>当前延迟: <span class="delay-value" id="delayValue">150</span> 毫秒</div>
            </div>

            <div class="card refresh-control">
                <div class="card-header">
                    <h2 class="card-title">ㅤㅤㅤㅤㅤㅤㅤ🔄 订单刷新间隔🔄</h2>
                </div>
                
                <input type="range" class="refresh-slider" id="refreshSlider" min="0.1" max="2" step="0.1" value="1.5">
                <div>刷新间隔: <span class="refresh-value" id="refreshValue">1.5</span> 秒</div>
            </div>

            <div class="card">
                <div class="checkbox-container">
                    <input type="checkbox" id="autoStopCheckbox" checked>
                    <label for="autoStopCheckbox">抢到一单后自动停止</label>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="autoBlacklistCheckbox" checked>
                    <label for="autoBlacklistCheckbox">抢单失败后加入黑名单</label>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        开始抢单
                    </button>
                    <button class="btn btn-outline" id="stopBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="6" y="4" width="12" height="16" rx="1"></rect>
                        </svg>
                        停止抢单
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ㅤㅤㅤㅤㅤㅤㅤㅤ📝 实时日志📝</h2>
                    <button class="btn btn-outline" id="clearLogs">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        清空
                    </button>
                </div>
                
                <div class="log-stream" id="logStream">
                    <div class="log-entry">
                        <span class="log-time">[系统]</span>
                        <span class="log-message info">等待开始抢单...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设置标签页 -->
        <div id="settings-tab" class="tab-content">
            <div class="header">
                <div class="balance-container" id="balanceContainer">
                    <div class="balance-item">
                        <div class="balance-label">💰账号余额💰</div>
                        <div class="balance-value" id="accountBalance">加载中...</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">💰提现余额💰</div>
                        <div class="balance-value" id="frozenBalance">加载中...</div>
                    </div>
                </div>
                <h1 class="card-title">⚙️ 账号设置</h1>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">🔐 账号配置</h2>
                </div>
                
                <div class="form-group">
                    <label for="ids">ids (多个ID用逗号分隔)</label>
                    <input type="text" id="ids" placeholder="例如: 123456,789012">
                </div>
                
                <div class="form-group">
                    <label for="token">Token</label>
                    <input type="password" id="token" placeholder="请输入token">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveConfig">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1 2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        保存配置
                    </button>
                    <button class="btn btn-outline" id="loadConfig">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        加载配置
                    </button>
                </div>
            </div>
        </div>

        <!-- 成功记录标签页 -->
        <div id="records-tab" class="tab-content">
            <div class="header">
                <h1 class="card-title">📋 成功记录</h1>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">✅ 抢单成功记录</h2>
                    <button class="btn btn-danger" id="clearRecords">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        清空记录
                    </button>
                </div>
                
                <div class="records-summary">
                    <div class="records-summary-item">
                        <div class="records-summary-label">累计抢单</div>
                        <div class="records-summary-value" id="totalOrders">0</div>
                    </div>
                    <div class="records-summary-item">
                        <div class="records-summary-label">累计金额</div>
                        <div class="records-summary-value" id="totalAmount">0</div>
                    </div>
                </div>
                
                <div class="record-table-container">
                    <table class="record-table">
                        <thead>
                            <tr>
                                <th>⏰ 时间</th>
                                <th>🆔 订单ID</th>
                                <th>🌐 区域</th>
                                <th>💼 类型</th>
                                <th>💰 金额</th>
                                <th>⏱️ 延迟</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable">
                            <tr>
                                <td colspan="6">📭 暂无记录</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 未结算订单信息 -->
            <div class="card">
                <div class="card-header">
                    <div class="summary-header">
                        <span class="summary-icon">📊</span>
                        <h2 class="summary-title">未结算订单</h2>
                        <span class="emoji-badge status-unsettled">待结算 (◕‿◕)</span>
                        <div class="refresh-btn" id="refreshUnsettledBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                <path d="M3 3v5h5"></path>
                                <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                                <path d="M16 16h5v5"></path>
                            </svg>
                            刷新
                        </div>
                    </div>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">未结算订单数</div>
                        <div class="summary-value" id="unsettledCount">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">累计金额</div>
                        <div class="summary-value" id="unsettledTotalAmount">0</div>
                    </div>
                </div>
                
                <div class="record-table-container">
                    <table class="record-table">
                        <thead>
                            <tr>
                                <th>⏰ 时间</th>
                                <th>🆔 订单ID</th>
                                <th>🌐 区域</th>
                                <th>💼 类型</th>
                                <th>💰 金额</th>
                                <th>📌 状态</th>
                            </tr>
                        </thead>
                        <tbody id="unsettledTable">
                            <tr>
                                <td colspan="6">🔄 加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="show-more" id="showMoreUnsettled">
                    🚩 只显示前5条订单 (点击显示全部)
                </div>
            </div>

            <!-- 已结算订单信息 -->
            <div class="card">
                <div class="card-header">
                    <div class="summary-header">
                        <span class="summary-icon">✅</span>
                        <h2 class="summary-title">已结算订单</h2>
                        <span class="emoji-badge status-settled">已完成 (★ω★)</span>
                        <div class="refresh-btn" id="refreshSettledBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 5px;">
                                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                <path d="M3 3v5h5"></path>
                                <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                                <path d="M16 16h5v5"></path>
                            </svg>
                            刷新
                        </div>
                    </div>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">已结算订单数</div>
                        <div class="summary-value" id="settledCount">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">累计金额</div>
                        <div class="summary-value" id="settledTotalAmount">0</div>
                    </div>
                </div>
                
                <div class="record-table-container">
                    <table class="record-table">
                        <thead>
                            <tr>
                                <th>⏰ 时间</th>
                                <th>🆔 订单ID</th>
                                <th>🌐 区域</th>
                                <th>💼 类型</th>
                                <th>💰 金额</th>
                                <th>📌 状态</th>
                            </tr>
                        </thead>
                        <tbody id="settledTable">
                            <tr>
                                <td colspan="6">🔄 加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="show-more" id="showMoreSettled">
                    🚩 只显示前5条订单 (点击显示全部)
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量存储完整订单数据
        let allUnsettledOrders = [];
        let allSettledOrders = [];
        let showFullUnsettled = false;
        let showFullSettled = false;
        let balanceRefreshInterval = null; // 用于存储余额自动刷新的interval
        let apiRequestQueue = []; // API请求队列
        let isProcessingQueue = false; // 是否正在处理队列

        // 新增卡密验证功能
        async function fetchValidCardKeys() {
            try {
                const response = await fetch('https://lv521314.github.io/A/00.txt');
                if (!response.ok) {
                    throw new Error('获取卡密列表失败');
                }
                const text = await response.text();
                return text.split('\n').map(key => key.trim()).filter(key => key);
            } catch (error) {
                console.error('获取卡密列表出错:', error);
                return [];
            }
        }

        // 验证卡密
        async function validateCardKey(key) {
            const validKeys = await fetchValidCardKeys();
            return validKeys.includes(key);
        }

        // 登录功能
        document.addEventListener('DOMContentLoaded', async function() {
            const loginOverlay = document.getElementById('loginOverlay');
            const topNav = document.getElementById('topNav');
            const appContainer = document.getElementById('appContainer');
            const cardKeyInput = document.getElementById('cardKeyInput');
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            // 每次刷新页面都显示登录界面
            loginOverlay.style.display = 'flex';
            topNav.style.display = 'none';
            appContainer.style.display = 'none';
            
            loginBtn.addEventListener('click', async function() {
                const key = cardKeyInput.value.trim();
                if (!key) {
                    loginError.textContent = '请输入卡密';
                    return;
                }
                
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="login-loading"></span>验证中...';
                loginError.textContent = '';
                
                try {
                    const isValid = await validateCardKey(key);
                    if (isValid) {
                        loginOverlay.style.display = 'none';
                        topNav.style.display = 'flex';
                        appContainer.style.display = 'block';
                        initApp();
                    } else {
                        loginError.textContent = '卡密无效，请重新输入';
                    }
                } catch (error) {
                    loginError.textContent = '验证失败: ' + error.message;
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = '登录';
                }
            });
            
            // 回车键登录
            cardKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
        });

        // 初始化应用
        function initApp() {
            // 极速版配置
            const config = {
                apiBaseUrl: "https://paidan.xlt666.club/yxdl/api",
                ids: [],
                token: '',
                baseDelay: 15,      // 基础延迟150ms
                minDelay: 1,       // 最小延迟100ms
                maxDelay: 30,       // 最大延迟300ms
                baseInterval: 150,  // 基础间隔1.5秒
                minInterval: 10,   // 最小间隔1秒
                areaFilter: 'all',
                keywords: ['开荒单'],
                customKeywords: '',
                blacklistKeywords: '',
                blacklistOrderIds: [],
                stopAfterSuccess: true,
                autoBlacklist: true, // 新增自动黑名单功能
                isRunning: false,
                stats: {
                    successCount: 0,
                    refreshCount: 0,
                    avgResponse: 0,
                    lastRequestTime: 0,
                    lastProcessTime: 0,
                    unsettledTotal: 0,  // 新增未结算总金额
                    settledTotal: 0      // 新增已结算总金额
                },
                // 智能调整参数
                speedFactor: 1.0,
                // 缓存系统
                cache: {
                    orders: null,
                    expiry: 0,
                    duration: 2000    // 2秒缓存
                },
                // 性能追踪
                performance: {
                    requestTimes: [],
                    processTimes: []
                }
            };
            
            // 独立存储成功记录
            let successRecords = JSON.parse(localStorage.getItem('permanentRecords') || '[]');
            
            // DOM元素
            const idsInput = document.getElementById('ids');
            const tokenInput = document.getElementById('token');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const saveConfigBtn = document.getElementById('saveConfig');
            const loadConfigBtn = document.getElementById('loadConfig');
            const clearRecordsBtn = document.getElementById('clearRecords');
            const clearLogsBtn = document.getElementById('clearLogs');
            const autoStopCheckbox = document.getElementById('autoStopCheckbox');
            const autoBlacklistCheckbox = document.getElementById('autoBlacklistCheckbox');
            const indicator = document.querySelector('.indicator');
            const successCountEl = document.getElementById('successCount');
            const unsettledAmountEl = document.getElementById('unsettledAmount');
            const settledAmountEl = document.getElementById('settledAmount');
            const lastUpdateEl = document.getElementById('lastUpdate');
            const logStream = document.getElementById('logStream');
            const recordsTable = document.getElementById('recordsTable');
            const keywordTags = document.querySelectorAll('.keyword-tag');
            const customKeywordsInput = document.getElementById('customKeywords');
            const blacklistKeywordsInput = document.getElementById('blacklistKeywords');
            const keywordSearchInput = document.getElementById('keywordSearch');
            const areaOptions = document.querySelectorAll('.area-option');
            const delaySlider = document.getElementById('delaySlider');
            const delayValue = document.getElementById('delayValue');
            const refreshSlider = document.getElementById('refreshSlider');
            const refreshValue = document.getElementById('refreshValue');
            const navLinks = document.querySelectorAll('.nav-link');
            const tabContents = document.querySelectorAll('.tab-content');
            const totalOrdersEl = document.getElementById('totalOrders');
            const totalAmountEl = document.getElementById('totalAmount');
            const accountBalanceEl = document.getElementById('accountBalance');
            const frozenBalanceEl = document.getElementById('frozenBalance');
            
            // 新增用户信息相关DOM元素
            const unsettledCountEl = document.getElementById('unsettledCount');
            const unsettledTotalAmountEl = document.getElementById('unsettledTotalAmount');
            const unsettledTable = document.getElementById('unsettledTable');
            const settledCountEl = document.getElementById('settledCount');
            const settledTotalAmountEl = document.getElementById('settledTotalAmount');
            const settledTable = document.getElementById('settledTable');
            const refreshUnsettledBtn = document.getElementById('refreshUnsettledBtn');
            const refreshSettledBtn = document.getElementById('refreshSettledBtn');
            const showMoreUnsettled = document.getElementById('showMoreUnsettled');
            const showMoreSettled = document.getElementById('showMoreSettled');
            
            // 初始化
            loadConfig();
            setupEventListeners();
            updateStatsDisplay();
            loadSuccessRecords();
            loadUnsettledOrders(); // 初始化时加载未结算订单
            loadSettledOrders();   // 初始化时加载已结算订单
            addLog('🎉 系统初始化完成', 'info');
            
            // 实时更新时间显示
            setInterval(() => {
                const now = new Date();
                lastUpdateEl.textContent = `最后更新: ${now.toLocaleTimeString()}`;
            }, 1000);
            
            // 设置事件监听器
            function setupEventListeners() {
                // 导航菜单切换
                navLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const tabId = this.dataset.tab;
                        
                        // 更新导航状态
                        navLinks.forEach(nav => nav.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 更新内容显示
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === `${tabId}-tab`) {
                                content.classList.add('active');
                            }
                        });
                        
                        // 如果是记录页，刷新数据
                        if (tabId === 'records') {
                            loadSuccessRecords();
                            loadUnsettledOrders();
                            loadSettledOrders();
                        }
                        
                        // 如果是用户信息页，启动自动刷新
                        if (tabId === 'settings') {
                            if (!balanceRefreshInterval) {
                                balanceRefreshInterval = startBalanceAutoRefresh();
                            }
                        } else {
                            // 如果不是用户信息页，清除自动刷新
                            if (balanceRefreshInterval) {
                                clearInterval(balanceRefreshInterval);
                                balanceRefreshInterval = null;
                            }
                        }
                    });
                });
                
                // 开始抢单
                startBtn.addEventListener('click', startOrderGrabber);
                
                // 停止抢单
                stopBtn.addEventListener('click', stopOrderGrabber);
                
                // 保存配置
                saveConfigBtn.addEventListener('click', saveConfig);
                
                // 加载配置
                loadConfigBtn.addEventListener('click', loadConfig);
                
                // 清空日志
                clearLogsBtn.addEventListener('click', function() {
                    logStream.innerHTML = '';
                    addLog('🧹 日志已清空', 'info');
                });
                
                // 清空记录
                clearRecordsBtn.addEventListener('click', function() {
                    if (confirm('⚠️ 确定要清空所有成功记录吗？此操作不可恢复！')) {
                        successRecords = [];
                        localStorage.setItem('permanentRecords', JSON.stringify(successRecords));
                        loadSuccessRecords();
                        addLog('🗑️ 已清空所有成功记录', 'warning');
                    }
                });
                
                // 关键词选择
                keywordTags.forEach(tag => {
                    tag.addEventListener('click', function() {
                        this.classList.toggle('active');
                        config.keywords = getSelectedKeywords();
                        saveConfigToLocal();
                    });
                });
                
                // 自定义关键词
                customKeywordsInput.addEventListener('change', function() {
                    config.customKeywords = this.value;
                    config.keywords = getSelectedKeywords();
                    saveConfigToLocal();
                });
                
                // 黑名单关键词
                blacklistKeywordsInput.addEventListener('change', function() {
                    config.blacklistKeywords = this.value;
                    saveConfigToLocal();
                });
                
                // 区域选择
                areaOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        areaOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        config.areaFilter = this.dataset.area;
                        saveConfigToLocal();
                    });
                });
                
                // 延迟滑块
                delaySlider.addEventListener('input', function() {
                    config.baseDelay = parseInt(this.value);
                    delayValue.textContent = this.value;
                    saveConfigToLocal();
                });
                
                // 刷新间隔滑块
                refreshSlider.addEventListener('input', function() {
                    config.baseInterval = parseFloat(this.value) * 1000; // 转换为毫秒
                    refreshValue.textContent = this.value;
                    saveConfigToLocal();
                });
                
                // 自动黑名单选项
                autoBlacklistCheckbox.addEventListener('change', function() {
                    config.autoBlacklist = this.checked;
                    saveConfigToLocal();
                });
                
                // 刷新未结算订单
                refreshUnsettledBtn.addEventListener('click', loadUnsettledOrders);
                
                // 刷新已结算订单
                refreshSettledBtn.addEventListener('click', loadSettledOrders);
                
                // 显示更多未结算订单
                showMoreUnsettled.addEventListener('click', function() {
                    showFullUnsettled = !showFullUnsettled;
                    renderUnsettledTable();
                });
                
                // 显示更多已结算订单
                showMoreSettled.addEventListener('click', function() {
                    showFullSettled = !showFullSettled;
                    renderSettledTable();
                });
            }
            
            // 自动刷新余额数据
            function startBalanceAutoRefresh() {
                // 先立即刷新一次
                refreshBalanceData();
                
                // 然后每6秒刷新一次
                const refreshInterval = setInterval(() => {
                    if (document.querySelector('#settings-tab').classList.contains('active')) {
                        refreshBalanceData();
                    }
                }, 6000);
                
                // 返回interval ID以便后续清除
                return refreshInterval;
            }

            // 刷新余额数据
            async function refreshBalanceData() {
                if (config.ids.length > 0 && config.token) {
                    try {
                        const balance = await fetchAccountBalance(config.ids[0]);
                        accountBalanceEl.textContent = balance.brokerageMoney.toFixed(2);
                        frozenBalanceEl.textContent = balance.freezeMoney.toFixed(2);
                        addLog('🔄 余额数据已刷新', 'refresh');
                    } catch (error) {
                        console.error('刷新余额出错:', error);
                    }
                }
            }
            
            // 获取账号余额
            async function fetchAccountBalance(memberId) {
                try {
                    const response = await fetchWithRetry(
                        `https://paidan.xlt666.club/yxdl/api/memberBalance/getInfo?memberId=${memberId}`, 
                        { headers: { "token": config.token } }
                    );
                    
                    if (!response.ok) throw new Error('获取余额失败');
                    
                    const data = await response.json();
                    if (data.code === 200) {
                        return {
                            brokerageMoney: data.data.brokerageMoney || 0,
                            freezeMoney: data.data.freezeMoney || 0
                        };
                    } else {
                        throw new Error(data.msg || '获取余额失败');
                    }
                } catch (error) {
                    console.error('获取余额出错:', error);
                    return { brokerageMoney: 0, freezeMoney: 0 };
                }
            }
            
            // 带重试机制的fetch请求
            async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response;
                } catch (error) {
                    if (retries > 0) {
                        await sleep(delay);
                        return fetchWithRetry(url, options, retries - 1, delay * 1.5);
                    } else {
                        throw error;
                    }
                }
            }
            
            function updateStatsDisplay() {
                successCountEl.textContent = config.stats.successCount;
                unsettledAmountEl.textContent = config.stats.unsettledTotal.toFixed(2);
                settledAmountEl.textContent = config.stats.settledTotal.toFixed(2);
            }
            
            // 加载未结算订单
            async function loadUnsettledOrders() {
                if (!config.token || config.ids.length === 0) {
                    unsettledTable.innerHTML = '<tr><td colspan="6">🔒 请先配置ID和Token</td></tr>';
                    return;
                }

                try {
                    const memberId = config.ids[0];
                    const headers = { "token": config.token };
                    allUnsettledOrders = [];
                    let totalAmount = 0;
                    
                    unsettledTable.innerHTML = '<tr><td colspan="6">⏳ 正在加载未结算订单...</td></tr>';
                    
                    // 分页获取所有未结算订单
                    for (let pageNum = 1; pageNum <= 10; pageNum++) {
                        const response = await fetchWithRetry(
                            `${config.apiBaseUrl}/order/myList?pageSize=10&pageNum=${pageNum}&memberId=${memberId}&status=3`, 
                            { headers }
                        );
                        
                        const data = await response.json();
                        if (data.rows && data.rows.length > 0) {
                            allUnsettledOrders = allUnsettledOrders.concat(data.rows);
                            
                            // 计算总金额
                            data.rows.forEach(order => {
                                const price = parseFloat((order.outPrice || "0").replace(/[^\d.-]/g, ""));
                                totalAmount += isNaN(price) ? 0 : price;
                            });
                        } else {
                            break;
                        }
                    }
                    
                    // 更新统计信息
                    unsettledCountEl.textContent = allUnsettledOrders.length;
                    unsettledTotalAmountEl.textContent = totalAmount.toFixed(2);
                    config.stats.unsettledTotal = totalAmount; // 更新全局统计
                    updateStatsDisplay();
                    
                    // 显示前5条或全部
                    renderUnsettledTable();
                    
                    addLog(`🔄 已加载 ${allUnsettledOrders.length} 条未结算订单，总金额: ${totalAmount.toFixed(2)}`, 'success');
                } catch (error) {
                    console.error('加载未结算订单出错:', error);
                    unsettledTable.innerHTML = `<tr><td colspan="6">❌ 加载失败: ${error.message}</td></tr>`;
                    addLog(`❌ 加载未结算订单失败: ${error.message}`, 'error');
                }
            }

            // 加载已结算订单
            async function loadSettledOrders() {
                if (!config.token || config.ids.length === 0) {
                    settledTable.innerHTML = '<tr><td colspan="6">🔒 请先配置ID和Token</td></tr>';
                    return;
                }

                try {
                    const memberId = config.ids[0];
                    const headers = { "token": config.token };
                    allSettledOrders = [];
                    let totalAmount = 0;
                    
                    settledTable.innerHTML = '<tr><td colspan="6">⏳ 正在加载已结算订单...</td></tr>';
                    
                    // 分页获取所有已结算订单(最多500条)
                    for (let pageNum = 1; pageNum <= 50; pageNum++) {
                        const response = await fetchWithRetry(
                            `${config.apiBaseUrl}/order/myList?pageSize=10&pageNum=${pageNum}&memberId=${memberId}&status=4`, 
                            { headers }
                        );
                        
                        const data = await response.json();
                        if (data.rows && data.rows.length > 0) {
                            allSettledOrders = allSettledOrders.concat(data.rows);
                            
                            // 计算总金额
                            data.rows.forEach(order => {
                                const price = parseFloat((order.outPrice || "0").replace(/[^\d.-]/g, ""));
                                totalAmount += isNaN(price) ? 0 : price;
                            });
                        } else {
                            break;
                        }
                    }
                    
                    // 更新统计信息
                    settledCountEl.textContent = allSettledOrders.length;
                    settledTotalAmountEl.textContent = totalAmount.toFixed(2);
                    config.stats.settledTotal = totalAmount; // 更新全局统计
                    updateStatsDisplay();
                    
                    // 显示前5条或全部
                    renderSettledTable();
                    
                    addLog(`🔄 已加载 ${allSettledOrders.length} 条已结算订单，总金额: ${totalAmount.toFixed(2)}`, 'success');
                } catch (error) {
                    console.error('加载已结算订单出错:', error);
                    settledTable.innerHTML = `<tr><td colspan="6">❌ 加载失败: ${error.message}</td></tr>`;
                    addLog(`❌ 加载已结算订单失败: ${error.message}`, 'error');
                }
            }

            // 渲染未结算表格(前5条或全部)
            function renderUnsettledTable() {
                const ordersToShow = showFullUnsettled ? allUnsettledOrders : allUnsettledOrders.slice(0, 3);
                
                if (ordersToShow.length === 0) {
                    unsettledTable.innerHTML = '<tr><td colspan="6">🛒 暂无未结算订单</td></tr>';
                    return;
                }
                
                let html = '';
                ordersToShow.forEach(order => {
                    html += `
                        <tr class="table-row">
                            <td>${order.createTime ? new Date(order.createTime).toLocaleString() : '⏳ 未知'}</td>
                            <td>${order.taskId || '🆔 未知'}</td>
                            <td>${order.categoryName || '🌐 未知'}</td>
                            <td>${order.taskName || '💼 未知'}</td>
                            <td>${order.outPrice || '0.00'} 💰</td>
                            <td><span class="emoji-badge status-unsettled">待结算</span></td>
                        </tr>
                    `;
                });
                
                unsettledTable.innerHTML = html;
                showMoreUnsettled.textContent = 
                    showFullUnsettled ? '👆 显示全部订单' : `🚩 只显示前5条订单 (共${allUnsettledOrders.length}条)`;
            }

            // 渲染已结算表格(前5条或全部)
            function renderSettledTable() {
                const ordersToShow = showFullSettled ? allSettledOrders : allSettledOrders.slice(0, 3);
                
                if (ordersToShow.length === 0) {
                    settledTable.innerHTML = '<tr><td colspan="6">📭 暂无已结算订单</td></tr>';
                    return;
                }
                
                let html = '';
                ordersToShow.forEach(order => {
                    html += `
                        <tr class="table-row">
                            <td>${order.createTime ? new Date(order.createTime).toLocaleString() : '⏳ 未知'}</td>
                            <td>${order.taskId || '🆔 未知'}</td>
                            <td>${order.categoryName || '🌐 未知'}</td>
                            <td>${order.taskName || '💼 未知'}</td>
                            <td>${order.outPrice || '0.00'} 💰</td>
                            <td><span class="emoji-badge status-settled">已结算</span></td>
                        </tr>
                    `;
                });
                
                settledTable.innerHTML = html;
                showMoreSettled.textContent = 
                    showFullSettled ? '👆 显示全部订单' : `🚩 只显示前5条订单 (共${allSettledOrders.length}条)`;
            }
            
            // 保存配置到本地存储
            function saveConfigToLocal() {
                const configToSave = {
                    ids: config.ids,
                    token: config.token,
                    baseDelay: config.baseDelay,
                    baseInterval: config.baseInterval,
                    areaFilter: config.areaFilter,
                    keywords: config.keywords,
                    customKeywords: config.customKeywords,
                    blacklistKeywords: config.blacklistKeywords,
                    blacklistOrderIds: config.blacklistOrderIds,
                    stopAfterSuccess: config.stopAfterSuccess,
                    autoBlacklist: config.autoBlacklist
                };
                localStorage.setItem('orderGrabberConfig', JSON.stringify(configToSave));
            }
            
            // 加载配置
            async function loadConfig() {
                const savedConfig = localStorage.getItem('orderGrabberConfig');
                if (savedConfig) {
                    try {
                        const parsedConfig = JSON.parse(savedConfig);
                        
                        // 更新配置对象
                        config.ids = Array.isArray(parsedConfig.ids) 
                            ? parsedConfig.ids 
                            : (parsedConfig.ids || '').split(',').filter(id => id.trim()).map(id => parseInt(id.trim()));
                        config.token = parsedConfig.token || '';
                        config.baseDelay = parsedConfig.baseDelay || 150;
                        config.baseInterval = parsedConfig.baseInterval || 1500;
                        config.areaFilter = parsedConfig.areaFilter || 'all';
                        config.keywords = parsedConfig.keywords || ['开荒单'];
                        config.customKeywords = parsedConfig.customKeywords || '';
                        config.blacklistKeywords = parsedConfig.blacklistKeywords || '';
                        config.blacklistOrderIds = parsedConfig.blacklistOrderIds || [];
                        config.stopAfterSuccess = parsedConfig.stopAfterSuccess !== false;
                        config.autoBlacklist = parsedConfig.autoBlacklist !== false;
                        
                        // 更新UI
                        idsInput.value = Array.isArray(parsedConfig.ids) 
                            ? parsedConfig.ids.join(',') 
                            : (parsedConfig.ids || '');
                        tokenInput.value = config.token;
                        autoStopCheckbox.checked = config.stopAfterSuccess;
                        autoBlacklistCheckbox.checked = config.autoBlacklist;
                        delaySlider.value = config.baseDelay;
                        delayValue.textContent = config.baseDelay;
                        refreshSlider.value = config.baseInterval / 1000;
                        refreshValue.textContent = config.baseInterval / 1000;
                        customKeywordsInput.value = config.customKeywords;
                        blacklistKeywordsInput.value = config.blacklistKeywords;
                        
                        // 恢复关键词按钮状态
                        keywordTags.forEach(tag => {
                            if (config.keywords.includes(tag.textContent)) {
                                tag.classList.add('active');
                            } else {
                                tag.classList.remove('active');
                            }
                        });
                        
                        // 恢复区域选择
                        areaOptions.forEach(option => {
                            if (option.dataset.area === config.areaFilter) {
                                option.classList.add('active');
                            } else {
                                option.classList.remove('active');
                            }
                        });

                        // 如果有ID和token，加载余额
                        if (config.ids.length > 0 && config.token) {
                            const balance = await fetchAccountBalance(config.ids[0]);
                            accountBalanceEl.textContent = balance.brokerageMoney.toFixed(2);
                            frozenBalanceEl.textContent = balance.freezeMoney.toFixed(2);
                        }
                        
                        addLog('⚙️ 配置加载成功', 'success');
                    } catch (e) {
                        addLog('❌ 配置加载失败: ' + e.message, 'error');
                    }
                } else {
                    addLog('⚠️ 没有找到保存的配置', 'warning');
                }
            }
            
            // 保存配置
            async function saveConfig() {
                config.ids = idsInput.value.trim().split(',').filter(id => id.trim()).map(id => parseInt(id.trim()));
                config.token = tokenInput.value.trim();
                config.stopAfterSuccess = autoStopCheckbox.checked;
                config.autoBlacklist = autoBlacklistCheckbox.checked;
                config.keywords = getSelectedKeywords();
                config.blacklistKeywords = blacklistKeywordsInput.value.trim();
                
                saveConfigToLocal();

                // 如果有ID和token，加载余额
                if (config.ids.length > 0 && config.token) {
                    const balance = await fetchAccountBalance(config.ids[0]);
                    accountBalanceEl.textContent = balance.brokerageMoney.toFixed(2);
                    frozenBalanceEl.textContent = balance.freezeMoney.toFixed(2);
                }
                
                addLog('💾 配置已保存', 'success');
            }
            
            // 获取选中的关键词
            function getSelectedKeywords() {
                const keywords = [];
                
                // 从快捷按钮获取
                document.querySelectorAll('.keyword-tag.active').forEach(tag => {
                    keywords.push(tag.textContent);
                });
                
                // 从自定义输入获取
                if (customKeywordsInput.value.trim()) {
                    customKeywordsInput.value.trim().split(',').forEach(kw => {
                        if (kw.trim()) keywords.push(kw.trim());
                    });
                }
                
                return keywords;
            }
            
            // 获取黑名单关键词
            function getBlacklistKeywords() {
                if (!config.blacklistKeywords) return [];
                return config.blacklistKeywords.split(',').map(kw => kw.trim()).filter(kw => kw);
            }
            
            // 智能动态延迟计算
            function getDynamicDelay() {
                // 根据最近5次的平均响应时间动态调整
                const lastRequests = config.performance.requestTimes.slice(-5);
                const avgRequest = lastRequests.reduce((a, b) => a + b, 0) / (lastRequests.length || 1);
                
                // 根据API响应时间调整延迟
                let dynamicDelay = config.baseDelay;
                if (avgRequest > 500) {
                    // 如果API响应慢，适当增加延迟避免频繁请求
                    dynamicDelay = Math.min(config.baseDelay * 1.5, config.maxDelay);
                } else if (avgRequest < 200) {
                    // 如果API响应快，可以适当减少延迟
                    dynamicDelay = Math.max(config.baseDelay * 0.8, config.minDelay);
                }
                
                // 根据当前速度因子调整
                dynamicDelay = Math.max(config.minDelay, Math.min(config.maxDelay, dynamicDelay * config.speedFactor));
                
                return Math.round(dynamicDelay);
            }
            
            // 智能动态间隔计算
            function getDynamicInterval() {
                // 根据系统负载动态调整
                const lastProcessTimes = config.performance.processTimes.slice(-5);
                const avgProcess = lastProcessTimes.reduce((a, b) => a + b, 0) / (lastProcessTimes.length || 1);
                
                let dynamicInterval = config.baseInterval;
                if (avgProcess > 1000) {
                    // 如果处理时间长，适当增加间隔
                    dynamicInterval = Math.min(config.baseInterval * 1.3, 5000);
                } else if (avgProcess < 500) {
                    // 如果处理时间短，可以适当减少间隔
                    dynamicInterval = Math.max(config.baseInterval * 0.7, config.minInterval);
                }
                
                return Math.round(dynamicInterval);
            }
            
            // 开始抢单
            function startOrderGrabber() {
                if (!config.token) {
                    addLog('❌ 请先配置Token并保存', 'error');
                    return;
                }
                
                if (config.ids.length === 0) {
                    addLog('❌ 请先配置ids并保存', 'error');
                    return;
                }
                
                config.isRunning = true;
                config.stats = {
                    successCount: 0,
                    refreshCount: 0,
                    avgResponse: 0,
                    lastRequestTime: 0,
                    lastProcessTime: 0,
                    unsettledTotal: 0,
                    settledTotal: 0
                };
                
                // 清空性能数据
                config.performance = {
                    requestTimes: [],
                    processTimes: []
                };
                
                // 更新UI
                indicator.classList.add('active');
                indicator.nextElementSibling.textContent = '运行中';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
                updateStatsDisplay();
                
                addLog('🚀 开始抢单...', 'highlight');
                addLog(`🔍 当前关键词: ${config.keywords.join(', ')}`, 'info');
                addLog(`🚫 黑名单关键词: ${getBlacklistKeywords().join(', ') || '无'}`, 'info');
                addLog(`🌐 目标区域: ${config.areaFilter === 'all' ? '全部' : config.areaFilter + '区'}`, 'info');
                addLog(`⏱️ 基础延迟: ${config.baseDelay}ms`, 'info');
                addLog(`🔄 基础刷新间隔: ${config.baseInterval/1000}秒`, 'info');
                
                // 开始抢单流程
                ultraFastOrderGrabbing();
            }
            
            // 极速抢单核心逻辑
            async function ultraFastOrderGrabbing() {
                while (config.isRunning) {
                    const cycleStart = Date.now();
                    let requestStart, requestEnd;
                    
                    try {
                        requestStart = Date.now();
                        
                        // 1. 获取订单列表（带缓存检查）
                        const orders = await fetchOrderListWithCache();
                        requestEnd = Date.now();
                        
                        const requestTime = requestEnd - requestStart;
                        config.performance.requestTimes.push(requestTime);
                        
                        config.stats.refreshCount++;
                        
                        // 更新最后刷新时间
                        const now = new Date();
                        lastUpdateEl.textContent = `最后更新: ${now.toLocaleTimeString()}`;
                        
                        addLog(`🔄 获取到 ${orders.length} 个订单 (${requestTime}ms)`, 'refresh');
                        
                        // 2. 并行处理订单过滤
                        const processStart = Date.now();
                        const matchedOrders = await filterOrdersParallel(orders);
                        const processTime = Date.now() - processStart;
                        config.performance.processTimes.push(processTime);
                        
                        if (matchedOrders.length > 0) {
                            addLog(`🎯 发现 ${matchedOrders.length} 个匹配订单`, 'highlight');
                            
                            // 3. 尝试抢单（并行处理前3个订单）
                            const takeOrderPromises = matchedOrders.slice(0, 1).map(order => 
                                takeOrder(order.taskId).catch(e => {
                                    addLog(`❌ 抢单出错: ${e.message}`, 'error');
                                    return null;
                                })
                            );
                            
                            const results = await Promise.all(takeOrderPromises);
                            
                            // 处理抢单结果
                            for (const result of results) {
                                if (!config.isRunning) break;
                                
                                if (result && result.success) {
                                    config.stats.successCount++;
                                    
                                    addLog(`✅ 成功订单: ${result.order.taskName}`, 'order');
                                    addLog(`👤 账号区分: ${result.order.categoryName}`, 'order');
                                    addLog(`📝 详情订单: ${result.order.description}`, 'order');
                                    addLog(`💰 到手金额: ${result.order.outPrice}`, 'order');
                                    addLog(`🎮 用户名字: ${result.order.gameRoleName}`, 'order');
                                    addLog(`🆔 用户 ID: ${result.order.gameRoleId}`, 'order');
                                    addLog(`💬 用户备注: ${result.order.remark}`, 'order');
                                    
                                    saveSuccessRecord(result.order, getDynamicDelay());
                                    
                                    // 抢到一单后自动停止
                                    if (config.stopAfterSuccess) {
                                        stopOrderGrabber();
                                        addLog('⏹️ 已自动停止抢单，如需继续请再次点击开始', 'info');
                                    }
                                    break; // 成功抢到一个订单后暂停
                                } else if (result && !result.success && config.autoBlacklist) {
                                    // 抢单失败且开启了自动黑名单，将订单加入黑名单
                                    const failedOrder = matchedOrders.find(o => o.taskId === result.taskId);
                                    if (failedOrder && !config.blacklistOrderIds.includes(failedOrder.taskId)) {
                                        config.blacklistOrderIds.push(failedOrder.taskId);
                                        saveConfigToLocal();
                                        addLog(`🚫 订单 ${failedOrder.taskId} 已加入黑名单`, 'warning');
                                    }
                                }
                            }
                        }
                        
                        // 计算平均响应时间
                        const totalTime = Date.now() - cycleStart;
                        config.stats.avgResponse = parseFloat(
                            ((config.stats.avgResponse * (config.stats.refreshCount - 1) + totalTime / 1000) / 
                            config.stats.refreshCount
                        ).toFixed(2));
                        updateStatsDisplay();
                        
                        // 动态计算延迟和间隔
                        const dynamicInterval = getDynamicInterval();
                        
                        // 等待动态间隔
                        await sleep(dynamicInterval);
                        
                    } catch (error) {
                        addLog(`❌ 获取订单列表失败: ${error.message}`, 'error');
                        await sleep(3000); // 出错时等待3秒再重试
                    }
                }
            }
            
            // 带缓存的订单列表获取
            async function fetchOrderListWithCache() {
                const now = Date.now();
                
                // 检查缓存是否有效
                if (config.cache.orders && now < config.cache.expiry) {
                    addLog('♻️ 使用缓存订单数据', 'info');
                    return config.cache.orders;
                }
                
                // 获取新数据
                const orders = await fetchOrderList();
                
                // 更新缓存
                config.cache.orders = orders;
                config.cache.expiry = now + config.cache.duration;
                
                return orders;
            }
            
            // 并行订单过滤
            async function filterOrdersParallel(orders) {
                return new Promise(resolve => {
                    // 使用setTimeout避免阻塞主线程
                    setTimeout(() => {
                        const blacklistKeywords = getBlacklistKeywords();
                        const matched = [];
                        
                        for (const order of orders) {
                            // 检查订单状态
                            if (order.state !== 1) continue;
                            
                            // 检查订单是否在黑名单中
                            if (config.blacklistOrderIds.includes(order.taskId)) continue;
                            
                            // 区域筛选
                            let areaMatch = true;
                            if (config.areaFilter !== 'all') {
                                const catName = (order.categoryName || '').toLowerCase();
                                areaMatch = (config.areaFilter === 'Q' && catName.includes('q区')) || 
                                            (config.areaFilter === 'V' && catName.includes('v区'));
                            }
                            
                            if (!areaMatch) continue;
                            
                            // 关键词筛选
                            let keywordMatch = true;
                            if (config.keywords.length > 0) {
                                const taskName = (order.taskName || '').toLowerCase();
                                const taskDesc = (order.description || '').toLowerCase();
                                keywordMatch = config.keywords.some(kw => 
                                    taskName.includes(kw.toLowerCase()) || 
                                    taskDesc.includes(kw.toLowerCase())
                                );
                            }
                            
                            if (!keywordMatch) continue;
                            
                            // 黑名单筛选
                            let blacklistMatch = false;
                            if (blacklistKeywords.length > 0) {
                                const remark = (order.remark || '').toLowerCase();
                                const publisherName = (order.publisherName || '').toLowerCase();
                                
                                blacklistMatch = blacklistKeywords.some(kw => 
                                    remark.includes(kw.toLowerCase()) || 
                                    publisherName.includes(kw.toLowerCase())
                                );
                            }
                            
                            if (!blacklistMatch) {
                                matched.push(order);
                            }
                        }
                        
                        resolve(matched);
                    }, 0);
                });
            }
            
            // 停止抢单
            function stopOrderGrabber() {
                config.isRunning = false;
                
                // 更新UI
                indicator.classList.remove('active');
                indicator.nextElementSibling.textContent = '未运行';
                startBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
                
                addLog(`⏹️ 已停止抢单 - 共刷新 ${config.stats.refreshCount} 次，抢到 ${config.stats.successCount} 单`, 'warning');
            }
            
            // 获取订单列表
            async function fetchOrderList() {
                try {
                    const headers = {
                        "token": config.token
                    };
                    
                    const response = await fetchWithRetry(`${config.apiBaseUrl}/order/list?pageSize=10&pageNum=1&categoryId=0`, {
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.code !== 200) {
                        throw new Error(data.msg || '获取订单失败');
                    }
                    
                    return data.rows || [];
                } catch (error) {
                    console.error('获取订单列表出错:', error);
                    throw error;
                }
            }
            
            // 抢单
            async function takeOrder(taskId) {
                try {
                    const delay = getDynamicDelay();
                    addLog(`⏳ 准备抢单 → 等待 ${delay}ms 延迟...`, 'info');
                    
                    // 应用动态延迟
                    await sleep(delay);
                    
                    const headers = {
                        "token": config.token,
                        "Content-Type": "application/json"
                    };
                    
                    const data = {
                        "taskId": taskId,
                        "ids": config.ids,
                        "nickname": "自动抢单工具",
                        "avatar": "https://xiaolatiao.oss-cn-beijing.aliyuncs.com/uploadImg-test/wYp4xWmXfR.jpg"
                    };
                    
                    const response = await fetchWithRetry(`${config.apiBaseUrl}/order/takeOrder`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.code === 200) {
                        // 获取订单详情
                        const orderDetail = await getOrderDetail(taskId);
                        return { 
                            success: true, 
                            order: orderDetail 
                        };
                    } else {
                        addLog(`⚠️ 抢单失败 → 原因: ${result.msg || '未知错误'}`, 'warning');
                        return { 
                            success: false, 
                            message: result.msg,
                            taskId: taskId
                        };
                    }
                } catch (error) {
                    console.error('抢单出错:', error);
                    addLog(`❌ 抢单出错 → ${error.message}`, 'error');
                    return { 
                        success: false, 
                        message: error.message,
                        taskId: taskId
                    };
                }
            }
            
            // 获取订单详情
            async function getOrderDetail(taskId) {
                try {
                    const headers = {
                        "token": config.token
                    };
                    
                    const response = await fetchWithRetry(`${config.apiBaseUrl}/order/getInfo?taskId=${taskId}`, {
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        return data.data || {};
                    } else {
                        throw new Error(data.msg || '获取详情失败');
                    }
                } catch (error) {
                    console.error('获取详情失败:', error);
                    addLog(`⚠️ 获取详情失败 → ${error.message}`, 'warning');
                    return {};
                }
            }
            
            // 保存成功记录
            function saveSuccessRecord(order, delayMs) {
                const record = {
                    time: new Date().toLocaleString(),
                    taskId: order.taskId || '未知',
                    area: order.categoryName || '未知区域',
                    type: order.taskName || '未知类型',
                    amount: order.outPrice || '未知',
                    delay: delayMs + 'ms'
                };
                
                successRecords.unshift(record); // 仍然存储所有记录
                localStorage.setItem('permanentRecords', JSON.stringify(successRecords));
                loadSuccessRecords(); // 调用修改后的显示函数
                
                // 更新统计信息
                const price = parseFloat((order.outPrice || "0").replace(/[^\d.-]/g, ""));
                if (!isNaN(price)) {
                    config.stats.unsettledTotal += price;
                    updateStatsDisplay();
                }
            }
            
            // 加载成功记录
            function loadSuccessRecords() {
                const records = successRecords;
                const displayCount = 3; // 表格只显示前3条记录

                if (records.length === 0) {
                    recordsTable.innerHTML = '<tr><td colspan="6">📭 暂无记录</td></tr>';
                    totalOrdersEl.textContent = '0';
                    totalAmountEl.textContent = '0';
                    return;
                }

                let html = '';
                let totalAmount = 0;

                // 计算全部记录的总金额
                records.forEach(record => {
                    if (record.amount) {
                        const price = parseFloat((record.amount || "0").replace(/[^\d.-]/g, ""));
                        if (!isNaN(price)) {
                            totalAmount += price;
                        }
                    }
                });

                // 只渲染前3条记录到表格
                const displayRecords = records.slice(0, displayCount);
                displayRecords.forEach(record => {
                    html += `
                        <tr class="table-row">
                            <td>${record.time}</td>
                            <td>${record.taskId}</td>
                            <td>${record.area}</td>
                            <td>${record.type}</td>
                            <td>${record.amount}</td>
                            <td>${record.delay}</td>
                        </tr>
                    `;
                });

                // 如果总记录数大于显示数量，添加提示
                if (records.length > displayCount) {
                    html += `
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--gray);">
                                🚩 只显示前${displayCount}条记录 (共${records.length}条)
                            </td>
                        </tr>
                    `;
                }

                recordsTable.innerHTML = html;
                totalOrdersEl.textContent = records.length;
                totalAmountEl.textContent = totalAmount.toFixed(2); // 显示全部记录的累计金额
            }
            
            // 添加日志
            function addLog(message, type = 'info') {
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry`;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'log-time';
                timeSpan.textContent = `[${timeStr}]`;
                
                const messageSpan = document.createElement('span');
                messageSpan.className = `log-message ${type}`;
                messageSpan.textContent = message;
                
                logEntry.appendChild(timeSpan);
                logEntry.appendChild(messageSpan);
                
                logStream.appendChild(logEntry);
                logStream.scrollTop = logStream.scrollHeight;
                
                // 限制日志数量
                if (logStream.children.length > 200) {
                    logStream.removeChild(logStream.children[0]);
                }
            }
            
            // 睡眠函数
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
    </script>
</body>
</html>
